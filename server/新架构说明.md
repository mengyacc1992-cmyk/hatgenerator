# 🎯 新后端架构说明

## ✨ 主要改进

### 1. 使用 Gemini 3 Flash
- **更快响应**：使用 `gemini-3-flash-preview` 作为主模型
- **自动降级**：如果 3 Flash 不可用，自动使用 `gemini-1.5-flash`
- **智能重试**：网络错误时自动重试（最多 3 次，指数退避）

### 2. 优化的网络配置
- **自动代理检测**：自动检测并使用系统代理
- **环境变量支持**：通过 `.env` 配置代理
- **优雅降级**：代理失败时尝试直接连接
- **超时控制**：30 秒超时，避免长时间等待

### 3. 更好的错误处理
- **分层错误处理**：网络层、API 层、业务层
- **友好错误消息**：中文错误提示，包含解决建议
- **详细日志**：便于调试和排查问题

### 4. 代码结构优化
- **模块化设计**：配置、服务、中间件分离
- **类型安全**：完整的 TypeScript 类型定义
- **易于维护**：清晰的代码结构

## 📁 新目录结构

```
server/
├── src/
│   ├── index.ts                    # 服务器入口
│   ├── config/
│   │   ├── network.ts              # 网络配置（代理、超时、重试）
│   │   └── gemini.ts              # Gemini API 配置
│   ├── services/
│   │   └── geminiService.ts       # Gemini API 服务（核心）
│   ├── routes/
│   │   └── api.ts                 # API 路由
│   ├── middleware/
│   │   ├── errorHandler.ts        # 错误处理中间件
│   │   └── validator.ts           # 请求验证中间件
│   └── types/
│       └── index.ts                # 类型定义（共享）
```

## 🔧 配置说明

### 环境变量（.env）

```bash
# Gemini API Key（必需）
GEMINI_API_KEY=your_api_key_here

# 使用的模型（可选，默认 gemini-3-flash-preview）
GEMINI_MODEL=gemini-3-flash-preview

# 服务器配置
PORT=3001
NODE_ENV=development

# CORS 配置
CORS_ORIGIN=http://localhost:3000

# 代理配置（可选）
HTTP_PROXY=http://127.0.0.1:10808
HTTPS_PROXY=http://127.0.0.1:10808
```

## 🚀 启动方式

### 开发模式
```bash
cd server
npm run dev
```

### 生产模式
```bash
cd server
npm run build
npm start
```

## 📊 API 端点

### POST /api/generate-topic
生成选题方案

**请求体：**
```json
{
  "selectedPoints": [...],
  "selectedHats": [...],
  "context": {
    "painPoint": "脸大显胖",
    "gender": "通用人群",
    "faceType": "圆脸 (Round)",
    "scenario": "都市通勤 (Commute)"
  }
}
```

### POST /api/generate-image-demands
生成图片需求卡片

**请求体：**
```json
{
  "topic": {...},
  "count": 12
}
```

### GET /api/health
健康检查

**响应：**
```json
{
  "status": "ok",
  "timestamp": "2026-01-14T13:00:00.000Z",
  "hasApiKey": true,
  "model": "gemini-3-flash-preview"
}
```

## 🔍 错误处理

### 网络错误
- **自动重试**：最多 3 次，指数退避
- **友好提示**：中文错误消息，包含解决建议

### API 错误
- **权限错误**：403，提示检查 API Key
- **配额错误**：429，提示检查账单
- **网络错误**：503，提示检查 VPN/网络

## 💡 使用建议

1. **优先使用 Tun 模式**：如果 VPN 支持，启用 Tun 模式最简单
2. **检查健康端点**：启动后访问 `/api/health` 确认配置
3. **查看日志**：后端终端会显示详细的运行信息

## 🎉 优势

- ✅ **更快**：使用 Gemini 3 Flash，响应速度更快
- ✅ **更可靠**：智能重试和错误处理
- ✅ **更简洁**：清晰的代码结构，易于维护
- ✅ **更灵活**：支持多种网络环境
