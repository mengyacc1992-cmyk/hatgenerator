# 🔧 "生成失败" 故障排查指南

## 错误信息
```
生成失败: exception TypeError: fetch failed sending request
```

## 问题说明

这个错误表示：**后端无法连接到 Google Gemini API**

## 可能的原因和解决方法

### 1. 网络连接问题 🌐

**症状：** 无法访问 Google 的 API 服务器

**解决方法：**
- 检查你的网络连接是否正常
- 如果你在中国大陆，可能需要使用 VPN 或代理
- 检查防火墙是否阻止了连接
- 尝试在浏览器访问：https://generativelanguage.googleapis.com （应该能看到 Google 的页面）

### 2. API Key 问题 🔑

**症状：** API Key 无效、过期或未启用

**检查步骤：**
1. 确认 `server/.env` 文件中的 `GEMINI_API_KEY` 是正确的
2. 访问 https://aistudio.google.com/ 检查 API Key 是否有效
3. 确认 API Key 对应的项目已开启账单

**解决方法：**
```bash
# 重新获取 API Key
1. 访问 https://aistudio.google.com/
2. 登录 Google 账号
3. 创建新项目或选择已有项目
4. 在项目设置中找到 API Key
5. 复制新的 API Key 到 server/.env
```

### 3. API 配额问题 💰

**症状：** 免费配额已用完

**解决方法：**
- 访问 Google Cloud Console
- 检查项目的账单设置
- 确认是否已启用付费账户
- 检查 API 使用配额

### 4. 模型名称问题 🤖

**症状：** 使用的模型不存在或不可用

**解决方法：**
- 检查 Gemini API 文档，确认模型名称是否正确
- 当前使用的是 `gemini-3-pro-preview`，如果不可用，可以尝试：
  - `gemini-1.5-pro`
  - `gemini-1.5-flash`

## 快速诊断步骤

### 步骤 1：检查后端服务

打开运行后端的终端窗口，查看是否有错误信息。

**正常情况应该看到：**
```
🚀 Server is running on http://localhost:3001
```

**如果有错误，会显示：**
```
Generate Topic Error: ...
```

### 步骤 2：测试 API Key

在终端运行：
```bash
cd server
node -e "require('dotenv').config(); console.log('API Key:', process.env.GEMINI_API_KEY ? '已配置' : '未配置');"
```

### 步骤 3：测试网络连接

在终端运行：
```bash
curl https://generativelanguage.googleapis.com
```

如果能访问，应该看到 Google 的响应。

### 步骤 4：查看详细错误

1. 打开运行后端的终端窗口
2. 尝试生成一个选题
3. 查看终端中显示的详细错误信息
4. 把错误信息告诉我，我可以帮你进一步诊断

## 常见错误信息对照

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| `fetch failed` | 网络连接失败 | 检查网络，可能需要 VPN |
| `PERMISSION_DENIED` | API Key 无效 | 重新获取 API Key |
| `API_KEY_INVALID` | API Key 格式错误 | 检查 .env 文件中的 Key |
| `QUOTA_EXCEEDED` | 配额用完 | 启用付费账户或等待配额重置 |
| `Requested entity was not found` | 模型不存在 | 检查模型名称 |

## 需要帮助？

如果以上方法都不行，请告诉我：

1. **后端终端显示的错误信息**（完整复制）
2. **你的网络环境**（是否在中国大陆，是否使用 VPN）
3. **API Key 的来源**（从哪个项目获取的）

这样我可以更准确地帮你解决问题！
